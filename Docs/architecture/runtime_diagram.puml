@startuml Runtime Diagram
title Runtime Diagram - Auth + Realni slucajevi na ulogovanoj pocetnoj

actor "Korisnik" as User
participant "Frontend Router" as Router
participant "DesktopGate" as Gate
participant "LoginPage" as Login
participant "App Route Guard" as Guard
participant "LoggedHomePage" as LoggedHome
participant "Cases API Client" as CasesClient
participant "Auth API Client" as AuthClient
participant "Express Auth API" as AuthApi
participant "Express Cases API" as CasesApi
participant "Auth Guard (JWT)" as JwtGuard
participant "Auth Service" as AuthService
participant "Cases Service" as CasesService
participant "Cases Repository" as CasesRepo
database "SQLite users tabela" as UsersStore
database "SQLite case_* tabele" as CasesStore
database "LocalStorage (session)" as SessionStore
participant "Desktop Notice View" as Notice

User -> Router: Otvara /prijava
Router -> Gate: Provera sirine viewport-a

alt Desktop sirina
  Gate -> Login: Render prijavne forme
  User -> Login: Unos kredencijala i submit
  Login -> AuthClient: POST /api/auth/login
  AuthClient -> AuthApi: HTTP zahtev
  AuthApi -> AuthService: validate + login
  AuthService -> UsersStore: Provera korisnika i lozinke

  alt Neispravni podaci
    AuthService --> AuthApi: 401/400 greska
    AuthApi --> AuthClient: JSON greska
    AuthClient --> Login: Poruke o greskama
    Login --> User: Prikaz greske
  else Uspesna prijava
    AuthService --> AuthApi: JWT token + user payload
    AuthApi --> AuthClient: JSON uspeh
    AuthClient -> SessionStore: Upis tokena i korisnika
    Login -> Router: Navigacija na /app
    Router -> Guard: Provera sesije
    Guard -> LoggedHome: Render ulogovane pocetne
    LoggedHome -> CasesClient: GET /api/cases/home (Bearer token)
    CasesClient -> CasesApi: HTTP zahtev
    CasesApi -> JwtGuard: Verifikacija tokena

    alt Token validan
      JwtGuard -> CasesService: getLoggedHomeOverview(userId)
      CasesService -> CasesRepo: upit sekcija + statistika
      CasesRepo -> CasesStore: SELECT active/resolved/top-rated/created
      CasesStore --> CasesRepo: realni podaci
      CasesRepo --> CasesService: agregirani rezultati
      CasesService --> CasesApi: response payload
      CasesApi --> CasesClient: JSON uspeh
      CasesClient --> LoggedHome: Render realnih slucajeva
    else Token nije validan
      JwtGuard --> CasesApi: 401 Unauthorized
      CasesApi --> CasesClient: JSON greska
      CasesClient --> LoggedHome: Pokretanje odjave
      LoggedHome -> SessionStore: Brisanje sesije
      LoggedHome -> Router: Navigacija na /
    end
  end
else Manja sirina od desktop praga
  Gate -> Notice: Render poruke "Aplikacija je samo za desktop"
  Notice --> User: Prikaz ogranicenog ekrana
end

@enduml
